{% extends 'base.html' %}
{% block title %}{{ hall.name }} Details{% endblock %}
{% block navbar %}{{ hall.name }}{% endblock %}
{% block head %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin=""/>
{% endblock %}
{% block content %}
<!-- Carousel for pictures -->
<div id="hallCarousel" class="carousel slide" data-ride="carousel">
  <div class="carousel-inner">
    {% for pic in pictures %}
      <div class="carousel-item {% if loop.first %}active{% endif %}">
        <img src="{{ url_for('static', filename='uploads/halls/' ~ pic) }}" class="d-block w-100 hall-carousel-image" alt="Hall image">
      </div>
    {% endfor %}
  </div>
  <a class="carousel-control-prev" href="#hallCarousel" role="button" data-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
  </a>
  <a class="carousel-control-next" href="#hallCarousel" role="button" data-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
  </a>
</div>

<!-- Button to go to booking page -->
<div class="mt-3">
  <a href="{{ url_for('main.book_hall', slug=hall.slug) }}" class="btn btn-primary">Book This Hall</a>
</div>

<!-- Small map showing hall location -->
<div id="smallMap" class="mt-3"></div>

<!-- Tabs for Morning and Evening details -->
<ul class="nav nav-tabs mt-4" id="timeTab" role="tablist">
  <li class="nav-item">
    <a class="nav-link active" id="morning-tab" data-toggle="tab" href="#morning" role="tab">Morning</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="evening-tab" data-toggle="tab" href="#evening" role="tab">Evening</a>
  </li>
</ul>
<div class="tab-content">
  <div class="tab-pane fade show active" id="morning" role="tabpanel">
    <h3 class="mt-3">Description</h3>
    <p>{{ morning_description }}</p>
    <h4>Highlights</h4>
    <ul>
      {% for hl in morning_highlights %}
        <li>{{ hl }}</li>
      {% endfor %}
    </ul>
    <h4>Discount</h4>
    <p>{{ morning_discount }}</p>
    <h4>Availability & Pricing (Morning)</h4>
    <div id="morning-calendar-container"></div>
    <div class="calendar-nav mt-2">
      <button id="morning-prev" class="btn btn-secondary">&larr; Previous</button>
      <span id="morning-current" class="mx-2"></span>
      <button id="morning-next" class="btn btn-secondary">Next &rarr;</button>
    </div>
  </div>
  <div class="tab-pane fade" id="evening" role="tabpanel">
    <h3 class="mt-3">Description</h3>
    <p>{{ evening_description }}</p>
    <h4>Highlights</h4>
    <ul>
      {% for hl in evening_highlights %}
        <li>{{ hl }}</li>
      {% endfor %}
    </ul>
    <h4>Discount</h4>
    <p>{{ evening_discount }}</p>
    <h4>Availability & Pricing (Evening)</h4>
    <div id="evening-calendar-container"></div>
    <div class="calendar-nav mt-2">
      <button id="evening-prev" class="btn btn-secondary">&larr; Previous</button>
      <span id="evening-current" class="mx-2"></span>
      <button id="evening-next" class="btn btn-secondary">Next &rarr;</button>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
<script>
  // Initialize small map (200x200)
  var smallMap = L.map('smallMap', { zoomControl: false, attributionControl: false }).setView([{{ hall.latitude }}, {{ hall.longitude }}], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(smallMap);
  L.marker([{{ hall.latitude }}, {{ hall.longitude }}]).addTo(smallMap);
</script>
<script>
  // Calendar data passed from server (12 months for each timeslot)
  var morningCalendars = {{ calendars.morning | tojson | safe }};
  var eveningCalendars = {{ calendars.evening | tojson | safe }};
  
  var currentMorningIndex = 0;
  var currentEveningIndex = 0;
  
  function renderCalendar(calData) {
    var monthStr = calData.month < 10 ? "0" + calData.month : calData.month;
    var html = "<h5>" + calData.year + "-" + monthStr + "</h5>";
    html += '<table class="table table-sm table-bordered"><thead><tr>';
    html += "<th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Sun</th>";
    html += "</tr></thead><tbody>";
    for (var i = 0; i < calData.weeks.length; i++) {
      html += "<tr>";
      for (var j = 0; j < calData.weeks[i].length; j++) {
        var day = calData.weeks[i][j];
        if (day) {
          html += '<td style="background-color: ' + day.status + ';">' + day.day + '<br><small>' + day.price + '</small></td>';
        } else {
          html += "<td></td>";
        }
      }
      html += "</tr>";
    }
    html += "</tbody></table>";
    return html;
  }
  
  function updateMorningCalendar() {
    var calData = morningCalendars[currentMorningIndex];
    document.getElementById('morning-calendar-container').innerHTML = renderCalendar(calData);
    var monthStr = calData.month < 10 ? "0" + calData.month : calData.month;
    document.getElementById('morning-current').innerText = calData.year + "-" + monthStr;
  }
  
  function updateEveningCalendar() {
    var calData = eveningCalendars[currentEveningIndex];
    document.getElementById('evening-calendar-container').innerHTML = renderCalendar(calData);
    var monthStr = calData.month < 10 ? "0" + calData.month : calData.month;
    document.getElementById('evening-current').innerText = calData.year + "-" + monthStr;
  }
  
  document.getElementById('morning-prev').addEventListener('click', function() {
    if (currentMorningIndex > 0) {
      currentMorningIndex--;
      updateMorningCalendar();
    }
  });
  document.getElementById('morning-next').addEventListener('click', function() {
    if (currentMorningIndex < morningCalendars.length - 1) {
      currentMorningIndex++;
      updateMorningCalendar();
    }
  });
  document.getElementById('evening-prev').addEventListener('click', function() {
    if (currentEveningIndex > 0) {
      currentEveningIndex--;
      updateEveningCalendar();
    }
  });
  document.getElementById('evening-next').addEventListener('click', function() {
    if (currentEveningIndex < eveningCalendars.length - 1) {
      currentEveningIndex++;
      updateEveningCalendar();
    }
  });
  
  // Initialize calendars on page load
  updateMorningCalendar();
  updateEveningCalendar();
</script>
{% endblock %}
